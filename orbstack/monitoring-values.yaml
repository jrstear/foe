# Helm values for kube-prometheus-stack on OrbStack
# Optimized for local development with minimal resource usage

# Prometheus configuration
prometheus:
  prometheusSpec:
    # Retention settings
    retention: 7d
    retentionSize: "5GB"
    
    # Resource limits for OrbStack
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 2Gi
    
    # Storage configuration
    storageSpec:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 10Gi
    
    # Service monitors - automatically discover Flux pods
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    
    # Additional scrape configs for Flux pods
    additionalScrapeConfigs:
      - job_name: 'flux-pods'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          # Only scrape pods with flux-related labels
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
            regex: flux.*
            action: keep
          # Add cluster label from pod labels
          - source_labels: [__meta_kubernetes_pod_label_cluster]
            target_label: cluster
          # Add location label from pod labels
          - source_labels: [__meta_kubernetes_pod_label_location]
            target_label: location
          # Add cost-tier label from pod labels
          - source_labels: [__meta_kubernetes_pod_label_cost_tier]
            target_label: cost_tier
          # Standard relabeling
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod

# Grafana configuration
grafana:
  # Dashboards
  dashboards:
    default:
      hybrid-view:
        json: |
          {
            "annotations": {
              "list": []
            },
            "editable": true,
            "gnetId": null,
            "graphTooltip": 0,
            "id": null,
            "links": [],
            "panels": [
              {
                "datasource": {
                  "type": "prometheus",
                  "uid": "Prometheus-Local"
                },
                "fieldConfig": {
                  "defaults": {
                    "color": {
                      "mode": "thresholds"
                    },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        {
                          "color": "green",
                          "value": null
                        },
                        {
                          "color": "red",
                          "value": 80
                        }
                      ]
                    }
                  },
                  "overrides": []
                },
                "gridPos": {
                  "h": 8,
                  "w": 12,
                  "x": 0,
                  "y": 0
                },
                "id": 1,
                "options": {
                  "colorMode": "value",
                  "graphMode": "area",
                  "justifyMode": "auto",
                  "orientation": "auto",
                  "reduceOptions": {
                    "calcs": [
                      "lastNotNull"
                    ],
                    "fields": "",
                    "values": false
                  },
                  "textMode": "auto",
                  "wideLayout": true
                },
                "pluginVersion": "11.1.0",
                "targets": [
                  {
                    "datasource": {
                      "type": "prometheus",
                      "uid": "Prometheus-Local"
                    },
                    "editorMode": "code",
                    "expr": "count(up{job=\"flux-pods\"})",
                    "legendFormat": "Local Nodes (OrbStack)",
                    "range": true,
                    "refId": "A"
                  }
                ],
                "title": "Local Nodes Up",
                "type": "stat"
              },
              {
                "datasource": {
                  "type": "prometheus",
                  "uid": "Prometheus-Cloud"
                },
                "fieldConfig": {
                  "defaults": {
                    "color": {
                      "mode": "thresholds"
                    },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        {
                          "color": "green",
                          "value": null
                        },
                        {
                          "color": "red",
                          "value": 80
                        }
                      ]
                    }
                  },
                  "overrides": []
                },
                "gridPos": {
                  "h": 8,
                  "w": 12,
                  "x": 12,
                  "y": 0
                },
                "id": 2,
                "options": {
                  "colorMode": "value",
                  "graphMode": "area",
                  "justifyMode": "auto",
                  "orientation": "auto",
                  "reduceOptions": {
                    "calcs": [
                      "lastNotNull"
                    ],
                    "fields": "",
                    "values": false
                  },
                  "textMode": "auto",
                  "wideLayout": true
                },
                "pluginVersion": "11.1.0",
                "targets": [
                  {
                    "datasource": {
                      "type": "prometheus",
                      "uid": "Prometheus-Cloud"
                    },
                    "editorMode": "code",
                    "expr": "flux_nodes_up",
                    "legendFormat": "Cloud Nodes (EKS)",
                    "range": true,
                    "refId": "A"
                  }
                ],
                "title": "Cloud Nodes Up",
                "type": "stat"
              },
              {
                "datasource": {
                  "type": "prometheus",
                  "uid": "Prometheus-Local"
                },
                "gridPos": {
                  "h": 8,
                  "w": 12,
                  "x": 0,
                  "y": 8
                },
                "id": 3,
                "options": {
                  "legend": {
                    "calcs": [],
                    "displayMode": "list",
                    "placement": "bottom",
                    "showLegend": true
                  },
                  "tooltip": {
                    "mode": "single",
                    "sort": "none"
                  }
                },
                "targets": [
                  {
                    "datasource": {
                      "type": "prometheus",
                      "uid": "Prometheus-Local"
                    },
                    "editorMode": "code",
                    "expr": "sum(flux_job_count) by (state)",
                    "legendFormat": "Local Jobs ({{state}})",
                    "range": true,
                    "refId": "A"
                  }
                ],
                "title": "Local Job Count",
                "type": "timeseries"
              },
              {
                "datasource": {
                  "type": "prometheus",
                  "uid": "Prometheus-Cloud"
                },
                "gridPos": {
                  "h": 8,
                  "w": 12,
                  "x": 12,
                  "y": 8
                },
                "id": 4,
                "options": {
                  "legend": {
                    "calcs": [],
                    "displayMode": "list",
                    "placement": "bottom",
                    "showLegend": true
                  },
                  "tooltip": {
                    "mode": "single",
                    "sort": "none"
                  }
                },
                "targets": [
                  {
                    "datasource": {
                      "type": "prometheus",
                      "uid": "Prometheus-Cloud"
                    },
                    "editorMode": "code",
                    "expr": "sum(flux_job_count) by (state)",
                    "legendFormat": "Cloud Jobs ({{state}})",
                    "range": true,
                    "refId": "A"
                  }
                ],
                "title": "Cloud Job Count",
                "type": "timeseries"
              }
            ],
            "schemaVersion": 39,
            "tags": [
              "flux",
              "hybrid"
            ],
            "templating": {
              "list": []
            },
            "time": {
              "from": "now-6h",
              "to": "now"
            },
            "timepicker": {},
            "timezone": "",
            "title": "Hybrid Flux View",
            "uid": "flux-hybrid-overview",
            "version": 2,
            "weekStart": ""
          }


  # Dashboard providers
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards/default

  
  # Admin credentials
  adminPassword: prom-operator
  
  # Resource limits
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  
  # Enable sidecar datasource provisioning
  sidecar:
    datasources:
      enabled: false
    dashboards:
      enabled: true
      label: grafana_dashboard
      searchNamespace: ALL
  
  # Datasources - local Prometheus only
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus-Local
          type: prometheus
          url: http://monitoring-kube-prometheus-prometheus.monitoring:9090
          access: proxy
          isDefault: true
          jsonData:
            timeInterval: 30s
        - name: Prometheus-Cloud
          type: prometheus
          url: http://a2c632c9d6a864e7c8f9f6788b20a7c7-6edc3092f454edfe.elb.us-west-2.amazonaws.com:9090
          access: proxy
          isDefault: false
          jsonData:
            timeInterval: 30s

# Alertmanager - disabled for local dev
alertmanager:
  enabled: false

# Node exporter - capture host metrics
nodeExporter:
  enabled: true

# Kube-state-metrics - capture k8s object state
kubeStateMetrics:
  enabled: true

# Disable components not needed for local dev
kubeControllerManager:
  enabled: false
kubeScheduler:
  enabled: false
kubeEtcd:
  enabled: false
kubeProxy:
  enabled: false
